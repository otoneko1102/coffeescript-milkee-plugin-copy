// Generated by CoffeeScript 2.7.0
var PREFIX, c, consola, deleteIgnoredFiles, fs, i, isIgnored, len, method, minimatch, path, pkg, pluginHandler, ref;

fs = require('fs');

path = require('path');

({minimatch} = require('minimatch'));

consola = require('consola');

pkg = require('../package.json');

PREFIX = `[${pkg.name}]`;

// Create a custom logger with prefix
c = {};

ref = ['log', 'info', 'success', 'warn', 'error', 'debug', 'start', 'box'];
for (i = 0, len = ref.length; i < len; i++) {
  method = ref[i];
  (function(method) {
    return c[method] = function(...args) {
      if (typeof args[0] === 'string') {
        args[0] = `${PREFIX} ${args[0]}`;
      }
      return consola[method](...args);
    };
  })(method);
}

// Check if file matches any pattern in the ignore list
isIgnored = function(file, patterns) {
  var j, len1, pattern;
  for (j = 0, len1 = patterns.length; j < len1; j++) {
    pattern = patterns[j];
    if (minimatch(file, pattern)) {
      return true;
    }
  }
  return false;
};

// Recursively delete files matching patterns from a directory
deleteIgnoredFiles = function(dir, patterns, baseDir = dir, deletedFiles = []) {
  var entries, entry, err, fullPath, j, len1, relPath, stat;
  try {
    if (fs.existsSync(dir)) {
      entries = fs.readdirSync(dir);
      for (j = 0, len1 = entries.length; j < len1; j++) {
        entry = entries[j];
        fullPath = path.join(dir, entry);
        relPath = path.relative(baseDir, fullPath).replace(/\\/g, '/');
        stat = fs.statSync(fullPath);
        if (stat.isDirectory()) {
          deleteIgnoredFiles(fullPath, patterns, baseDir, deletedFiles);
        } else {
          if (isIgnored(relPath, patterns)) {
            fs.unlinkSync(fullPath);
            deletedFiles.push(relPath);
          }
        }
      }
    } else {
      c.error(`Output directory does not exist: ${dir}`);
    }
  } catch (error) {
    err = error;
    c.error(`Error processing directory: ${err.message}`);
  }
  return deletedFiles;
};

// Main plugin function
pluginHandler = function(compilationResult, patterns = []) {
  var compiledFiles, config, deletedFiles, file, ignorePatterns, isCopyEnabled, j, len1, outputDir, ref1, ref2, results, stderr, stdout;
  ({config, compiledFiles, stdout, stderr} = compilationResult);
  // Check if copy option is enabled
  isCopyEnabled = (config != null ? (ref1 = config.milkee) != null ? (ref2 = ref1.options) != null ? ref2.copy : void 0 : void 0 : void 0) === true;
  if (!isCopyEnabled) {
    c.info("Copy option is not enabled. Plugin skipped.");
    return;
  }
  // Get ignore patterns
  ignorePatterns = patterns || [];
  if (ignorePatterns.length === 0) {
    c.info("No ignore patterns specified.");
    return;
  }
  // Get output directory from config
  outputDir = config != null ? config.output : void 0;
  if (!outputDir) {
    c.error("Output directory not specified in config.");
    return;
  }
  // Convert to absolute path if relative
  if (!path.isAbsolute(outputDir)) {
    outputDir = path.resolve(outputDir);
  }
  if (!fs.existsSync(outputDir)) {
    c.error(`Output directory does not exist: ${outputDir}`);
    return;
  }
  // Delete ignored files
  deletedFiles = deleteIgnoredFiles(outputDir, ignorePatterns);
  if (deletedFiles.length > 0) {
    c.success(`Deleted ${deletedFiles.length} file(s):`);
    results = [];
    for (j = 0, len1 = deletedFiles.length; j < len1; j++) {
      file = deletedFiles[j];
      results.push(c.log(`  - ${file}`));
    }
    return results;
  } else {
    return c.info("No files matched the ignore patterns.");
  }
};

// Plugin factory function
module.exports = function(options = {}) {
  var ignorePatterns;
  ignorePatterns = (options != null ? options.ignore : void 0) || [];
  return function(compilationResult) {
    return pluginHandler(compilationResult, ignorePatterns);
  };
};
